{"title":"Tool length install","icon":"fas fa-wrench","codetype":"javascript","gcode":"","javascript":"// Tool Length Control Macro For OpenBuilds Control\n// V 2.2\n// \n// ***IMPORTANT***\n// G30 (Starting point for probing) and G28 (Tool change location) ***MUST*** be set prior to using this macro. \n// \n// How to set these:\n// Jog the machine until it is directly above the tool setting probe, at an appropriate height, and send 'G30.1'\n// Jog the machine until it is at your chosen location for tool change and send 'G28.1'\n// (If you have already set G28 as a safe location, then you can just ignore the tool setting location.)\n// \n// Use at own risk!\n// DAG 27/2/23\n// V1.1 1/3/23 \ttc_probedistance variable added / console output from reference tool probe added\n// V1.2 4/4/23 \tChecks for machine state added (tc_safetycheck() & tc_homecheck() functions)\n//\t\t\t\tHome check can be disabled by setting tc_ignorehomestatus to \"yes\"\n//\t\t\t\tDefault values for probing revised (shorter & slower)\n//\t\t\t\tMacro can be re-run without adding menu button which allows feed rates, etc. to be changed without having to restart Control\n// V1.3\t11/4/23\tAdded console log for undefined tool status\n//\t\t\t\tCorrected message for reporting change to WCS after probing new tool when WCS offset has changed\n//\t\t\t\tAdded actual measurement to new tool message & reformatted text in messages\n// V1.4 4/9/23\tBug fix for Error 9 when setting new WCS offset (added tc_status 5)\n//\t\t\t\tAdded 'ignorehomestatus' message to console log\n//\t\t\t\tAdded Z clearance check before returning to home position (to catch machine Z>0)\n//\t\t\t\tDefault tc_ignorehomestatus to \"no\"\n// V1.5 ... 2.1 Trial versions for troubleshooting\n// V2.2 15/9/23\tRevised probing GCode strings to avoid $J command and use G0 for probe retract for compatability with GRBLHal\n//\n\n\n// Change these before running to customise basic operation:\n\nwindow.tc_seekdistance = \"45\";\t\t\t// Distance (mm) of initial probe to locate tool setter\nwindow.tc_seekspeed = \"150\";\t\t\t// Speed (mm/min) of initial probe to locate tool setter\nwindow.tc_retract = \"2\";\t\t\t\t// Distance (mm) to retract before tool length probing\nwindow.tc_probespeed = \"30\";\t\t\t// Speed (mm/min) for tool length probing\nwindow.tc_probedistance = \"5\";\t\t\t// Distance (mm) for tool length probing - must be greater than tc_retract\nwindow.tc_ignorehomestatus = \"yes\"\t\t// Ignores status of 'laststatus.machine.modals.homedRecently' if \"yes\".\nwindow.tc_finalzfeed = \"500\";\t\t\t// Speed (mm/min) used when the Z axis returns to the original tool position\n\t\t\t\t\t\t\t\t\t\t// ...make this slow enough to get to the E-stop if it goes wrong!\n\n//The rest of it...\n\n// Declare variables\nwindow.tc_version = \"2.2.0\";\t\t// Macro version for debugging\nwindow.tc_status = 0;\t\t\t\t// 0 = Waiting\n\t\t\t\t\t\t\t\t\t// 1 = Probe requested\n\t\t\t\t\t\t\t\t\t// 2 = Ready to probe\n\t\t\t\t\t\t\t\t\t// 3 = Locate tool setter\n\t\t\t\t\t\t\t\t\t// 4 = Probe tool\n\t\t\t\t\t\t\t\t\t// 5 = Set WCS offset\n\t\t\t\t\t\t\t\t\t// 6 = Move to tool change requested\n\t\t\t\t\t\t\t\t\t// 7 = Arrived at tool change\n\t\t\t\t\t\t\t\t\t// 8 = Return to original location requested\n\t\t\t\t\t\t\t\t\t// 9 = Arrived at original location\n\t\t\t\t\t\t\t\t\t// 99 = finished with dialog\n\nwindow.tc_needstorun = \"no\";\t\t// Is there Gcode pending?\nwindow.tc_waitingOK = \"no\";\t\t\t// Are we waiting for confirmation?\nwindow.tc_refset = \"no\";\t\t\t// Has the reference tool been set?\nwindow.tc_xpos = \"\";\t\t\t\t// Store current position\nwindow.tc_ypos = \"\";\t\t\t\t//\nwindow.tc_zpos = \"\";\t\t\t\t//\nwindow.tc_unitsmode = \"\";\t\t\t// Store current modal settings that we might change \nwindow.tc_distmode = \"\";\t\t\t//\nwindow.tc_coordsys = \"\";\t\t\t// For reference\nwindow.tc_offset = 0;\t\t\t\t// Measured reference tool offset - WCS is adjusted to maintain this for new tools\nwindow.tc_refWCSz = \"\";\t\t\t\t// WCS Z offset at time of tool measurement\nwindow.tc_newz = \"\";\t\t\t\t// Calculated Z offset for new tool\nwindow.tc_message = \"Initialising\";\t// Dialog text\nwindow.tc_ref = \"Reference\";\t\t// Identifiers to steer flow for reference or new tools\nwindow.tc_new = \"New\";\t\t\t\t//\n\n//Add \"tool offset\" button to toolbar\n\nif (!document.getElementById('grbltc_tlo')) {\t\t//If the macro has run, the button will be present, so we don't want to run it again\n//if (1==1){\t\t\t\t\t\t\t\t\t\t//(Comment out the line above and un-comment this one to disable run-once protection for debugging, etc.)\n\n\tvar tc_tlo = `<button id=\"grbltc_tlo\" class=\"ribbon-button\" onclick=\"tc_homecheck();\">\n\t\t\t\t\t <span class=\"icon\">\n\t\t\t\t\t   <span class=\"fa-layers fa-fw\">\n\t\t\t\t\t\t <i class=\"fas fa-ruler-vertical fa-rotate-180 fg-black\"></i>\n\t\t\t\t\t   </span>\n\t\t\t\t\t </span>\n\t\t\t\t\t <span class=\"caption grblmode\">Tool<br>Length</span>\n\t\t\t\t   </button>`\n\t$( \"#grblProbeMenu\" ).after( tc_tlo );\n}\nelse \n{\n\talert('Macro has already been run - no new button created.')\n};\n\n//End of Initialisation\n\n\nwindow.tc_initiate = function(){\t\t\t\t// Main body of program\n\n//Initialise variables\ntc_status = 0;\ntc_needstorun = \"no\";\ntc_waitingOK = \"no\";\ntc_xpos =\"\";\ntc_ypos =\"\";\ntc_zpos =\"\";\ntc_unitsmode = \"\";\ntc_distmode = \"\";\nwindow.tc_xpos = laststatus.machine.position.work[\"x\"]; \t\t//save the current tool position\nwindow.tc_ypos = laststatus.machine.position.work[\"y\"];\nwindow.tc_zpos = laststatus.machine.position.work[\"z\"];\nwindow.tc_unitsmode = laststatus.machine.modals[\"unitsmode\"]; \t//save any modal settings that we might change or reference\nwindow.tc_distmode = laststatus.machine.modals[\"distancemode\"];\nwindow.tc_coordsys = laststatus.machine.modals[\"coordinatesys\"];\n\nif (tc_refset==\"no\"){tc_message = \"No reference stored - Please set Reference Tool\";}\nelse {tc_message=\"Reference offset (\" + tc_offset + \")\";}\t\n\nif (tc_safetycheck() ==1){\t\t\t\t\t\t\t\t\t\t// Check that machine state is OK to run the macro\n\n// Create & show dialog\n\nMetro.dialog.create({\n    title: \"Tool Length Compensation via WCS\",\n    content: `\n\t\t   <span>Tool Setting station is at G28, Probe starting point at G30. These locations must be set up before using this macro. Be prepared for the machine to move immediately that the buttons below are clicked.</span>\n\t\t   <hr>\n\t\t   <button class=\"button success \" onclick=\"tc_tool = tc_ref; tc_status=1;\">Set Reference Tool</button>\n\t\t   <button class=\"button warning \" onclick=\"tc_tool = tc_new; tc_status=6\">Go To Tool Change</button>\n           <button class=\"button primary  disabled\" id=\"tc_changetool\" onclick=\"tc_tool = tc_new; tc_status=1\">Set New Tool</button>\n\t\t   <hr>\n           <span id=\"tc_log\">Please Select An Action</span>\n\t\t   <hr>\n           <button style=\"text-align:center\" id=\"tc_ok\" class=\"button large success  disabled \" onclick=\"tc_crackon();\">Proceed</button>\n       `,\n    actions: [{\n        caption: \"Close\",\n        cls: \"js-dialog-close alert \",\n        onclick: function() {\n            tc_status=99;\n            printLog(\"Tool Offset Dialog Exited\")\n\t\t\t}\n\t\t}]\n\t});\n// Add this line back into the dialog above for debug info: <button class=\"button\" onclick=\"tc_debug()\">Debug</button>\t\n\nprintLog(\"Tool Offset Dialog Opened\");\nconsole.log(\"Tool offset dialog V\" + tc_version + \" opened\");\n\n// Set up loop that handles the whole process\n\twindow.tc_refinterval = setInterval(function() {\n\t\n        tc_updateui();\n\t\t\n\t\tif (tc_needstorun == \"yes\"){\n\t\t\tif(laststatus.comms.runStatus == \"Run\") {\t\t//Make sure that any actions have started\n\t\t\t\ttc_needstorun = \"no\"; }\n\t\t\t}\n\t\telse if(laststatus.comms.runStatus != \"Run\")\t\t//wait for action to finish before going back into the loop\n\t\t{\t\t\n\t\t\t\n\t\tswitch (tc_status) \n\t\t{\n\t\tcase 0:\t//Waiting\n\t\t{\n\t\t\tbreak;\n\t\t}\n\t\tcase 1:\t//Tool probe requested\t\t\n\t\t{\n\t\t\ttc_message = \"Moving to probe location (G30)\";\n\t\t\ttc_waitingOK = \"no\"\n\t\t\t\n\t\t\tvar tc_prep =  `\n\t\t\tG21 \t\t;set mm mode\n\t\t\tG53 G0 Z-5\t;Raise to safe height in machine coordinates\n\t\t\tG30 G91 X0 Y0\t;Traverse to X & Y position for G30\n\t\t\tG30 G91 Z0\t;Lower to Z position for G30\n\t\t\t`\n\t\t\tsocket.emit('runJob', {\n\t\t\t\tdata: tc_prep,\n\t\t\t\tisJob: \"no\",\n\t\t\t\tcompletedMsg: \"\",\n\t\t\t\tfileName: \"\"\n\t\t\t});\t\n\n\t\t\ttc_needstorun = \"yes\";\n\t\t\ttc_status=2;\n\t\t\tbreak;\n\t\t}\n\t\tcase 2: \t//ready to probe\n\t\t{\n\t\t\ttc_message = \"Ready to measure \" + tc_tool + \" Tool<br><br>Position probe and connect wires if required before pressing Proceed\";\n\t\t\ttc_waitingOK = \"yes\";\n\t\t\ttc_status = 3;\n\t\t\tbreak;\n        }\n\t\tcase 3:\t  //Find tool setter\n\t\t{\n\t\tif (tc_waitingOK == \"yes\"){break;}\n\t\t\t\ttc_message = \"Locating tool setter in Z\";\n\t\t\t\tvar tc_probe =  `\n\t\t\t\t\tG21\t\t\t\t\t;set mm mode\n\t\t\t\t\tG38.3 Z-` + tc_seekdistance + ` F` + tc_seekspeed + ` ;probe using parameters at the top of the macro\n\t\t\t\t\tG4 P0.4\t\t\t\t;pause\n\t\t\t\t\tG91 G0 Z` + tc_retract\n\n\t\t\t\tsocket.off('prbResult'); // Disable old listeners\n\t\t\t\tsocket.emit('runJob', {\n\t\t\t\t\tdata: tc_probe,\n\t\t\t\t\tisJob: false,\n\t\t\t\t\tcompletedMsg: \"\",\n\t\t\t\t\tfileName: \"\"\n\t\t\t\t});\n\t\t\t\t\n\t\t\t\tsocket.on('prbResult', function(prbdata) {\n\t\t\t\tif (prbdata.state > 0) {\n\t\t\t\t\ttc_message = \"Located tool setter at \" + prbdata.z;\n\t\t\t\t\tprintLog(\"Located tool setter at \" + prbdata.z);\n\t\t\t\t\tsocket.off('prbResult');\n\t\t\t\t\ttc_status=4;\n\t\t\t\t\t//tc_waitingOK = \"yes\";\n\t\t\t\t\t}\n\n\t\t\t\telse {\n\t\t\t\t\ttc_message= \"Failed to locate tool setter - Operation cancelled<br><br>Remove probe / probe wire (if used) before moving away\";\n\t\t\t\t\tprintLog(\"Failed to locate tool setter - Operation cancelled\");\n\t\t\t\t\tsocket.off('prbResult');\n\t\t\t\t\ttc_status=0;\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\ttc_needstorun = \"yes\";\n\t\t\tbreak;\n\t\t}\n\t\tcase 4:\t  //probe tool\n\t\t{\n\t\tif (tc_waitingOK == \"yes\"){break;}\n\t\t\n\t\t\t\ttc_message = \"Measuring \" + tc_tool + \" Tool\";\n\t\t\t\t\t\t\t\t\n\t\t\t\tvar tc_probe =  `\n\t\t\t\t\tG21\t\t\t\t\t;set mm mode\n\t\t\t\t\tG38.3 Z-` + tc_probedistance + ` F` + tc_probespeed + `\t;probe at slow speed\n\t\t\t\t\tG4 P0.4\t\t\t\t;pause\n\t\t\t\t\tG91 G0 Z` + tc_retract\n\t\t\t\t\t\n\t\t\t\tsocket.off('prbResult'); // Disable old listeners\n\t\t\t\tsocket.emit('runJob', {\n\t\t\t\t\tdata: tc_probe,\n\t\t\t\t\tisJob: false,\n\t\t\t\t\tcompletedMsg: \"\",\n\t\t\t\t\tfileName: \"\"\n\t\t\t\t});\n\t\t\t\t\n\t\t\t\tsocket.on('prbResult', function(prbdata) {\n\t\t\t\t\tif (prbdata.state > 0) {\n\t\t\t\t\t\ttc_message = \"Measured \" +tc_tool +\" Tool offset at \" + prbdata.z + \"mm<br><br>Remove probe / probe wire (if used).<br><br>Press Proceed to return to the original position or choose another action\";\n\t\t\t\t\t\tprintLog(\"Measured \" +tc_tool +\" Tool Offset At \" + prbdata.z);\n\t\t\t\t\t\tsocket.off('prbResult');\n\t\t\t\t\t\t\n\t\t\t\t\t\tif(tc_tool == tc_ref){\t\t\t\t\t// Record offset of reference tool\n\t\t\t\t\t\t\ttc_offset = prbdata.z;\n\t\t\t\t\t\t\ttc_refWCSz = laststatus.machine.position.offset[\"z\"]; // Record WCS offset in force at the time.\n\t\t\t\t\t\t\ttc_refset = \"yes\";\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tconsole.log(\"Reference Tool Probe\");\n\t\t\t\t\t\t\tconsole.log(\"Measured Tool Offset \"+ tc_offset);\n\t\t\t\t\t\t\tconsole.log(\"Current WCS Offset \" + tc_refWCSz);\n\t\t\t\t\t\t\ttc_newz = tc_refWCSz;\t\t\t\t\t\t\t\t// For safety check on Z height\n\t\t\t\t\t\t\ttc_status = 8;\n\t\t\t\t\t\t\t//tc_waitingOK = \"yes\";\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (tc_tool == tc_new){ \t\t\t// Offset reference for new tool\n\t\t\t\t\t\t\n\t\t\t\t\t\t\tvar tc_result = prbdata.z;\n\t\t\t\t\t\t\tvar tc_nowWCSz = laststatus.machine.position.offset[\"z\"];\n\t\t\t\t\t\t\tvar tc_deltaz = (tc_result - tc_offset);\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\ttc_newz = tc_nowWCSz + tc_deltaz;\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tconsole.log(\"New Tool Probe\");\n\t\t\t\t\t\t\tconsole.log(\"Measured Tool Offset\" + tc_result);\n\t\t\t\t\t\t\tconsole.log(\"Current WCS Z offset \"+ tc_nowWCSz);\n\t\t\t\t\t\t\tconsole.log(\"Previous Tool Offset \"+ tc_offset);\n\t\t\t\t\t\t\tconsole.log(\"Previous WCS Offset \" + tc_refWCSz);\n\t\t\t\t\t\t\tconsole.log(\"New WCS Offset \"+(tc_newz).toFixed(3));\n\t\t\t\t\t\t\ttc_message = \"Measured tool offset \" + tc_result + \"mm<br>Z Offset of current WCS (\" + tc_coordsys + \") adjusted by \" + (tc_deltaz).toFixed(3) + \"mm<br><br>Remove probe / probe wire (if used)<br><br>Press Proceed to return to the original position or choose another action\";\n\t\t\t\t\t\t\tprintLog(\"Z Offset in \" + tc_coordsys + \" set to \" + tc_newz + \"(\"+ (tc_deltaz).toFixed(3) +\")\");\n\t\t\t\t\t\t\ttc_refWCSz = tc_nowWCSz;\n\t\t\t\t\t\t\ttc_offset= tc_result;\n\t\t\t\t\t\t\tconsole.log(\"Waiting to set new WCS offset\");\n\t\t\t\t\t\t\ttc_status=5;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttc_message = \"Undefined tool action \" + tc_status;\n\t\t\t\t\t\t\tprintLog(\"Undefined tool action \" + tc_status);\n\t\t\t\t\t\t\tconsole.log(\"Undefined tool action \" + tc_status);\n\t\t\t\t\t\t\ttc_status=0;\n\t\t\t\t\t\t}\t\t\t\t\n\t\t\t\t\t}\n\n\t\t\t\t\telse {\n\t\t\t\t\t\ttc_message= \"Tool length probe failed - Operation cancelled<br><br>Remove probe / probe wire (if used) before moving away\";\n\t\t\t\t\t\tprintLog(\"Probe Failed - Operation cancelled\");\n\t\t\t\t\t\tsocket.off('prbResult');\n\t\t\t\t\t\ttc_status=0;\n\t\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\n\t\t\ttc_needstorun = \"yes\";\n\t\t\ttc_waitingOK = \"yes\";\n\n\t\t\tbreak;\n\t\t}\n\t\tcase 5:\t\t//Set WCS to new offset\n\t\t{\n\t\t\tconsole.log(\"Ready to set new WCS offset\");\n\t\t\tsendGcode(\"G10 L2 P0 Z\"+tc_newz);\n\t\t\t//tc_needstorun = \"yes\";\n\t\t\ttc_status=8;\n\t\t\ttc_waitingOK = \"yes\";\n\t\t\tconsole.log(\"G10 command sent\");\n\t\t\tbreak;\n\t\t}\n\t\tcase 6:\t\t//Move to tool setting location\n\t\t{\t\n\t\t\ttc_message = \"Moving to tool change location (G28)\";\n\t\t\t\n\t\t\tvar tc_tchng =  `\n\t\t\tG21 \t\t;set mm mode\n\t\t\tG53 G0 Z-5\t;Raise to safe height in machine coordinates\n\t\t\tG28 G91 X0 Y0\t;Traverse to X & Y position for G28\n\t\t\tG28 G91 Z0\t;Lower to Z position for G28\n\t\t\t`\n\t\t\tsocket.emit('runJob', {\n\t\t\t\tdata: tc_tchng,\n\t\t\t\tisJob: \"no\",\n\t\t\t\tcompletedMsg: \"\",\n\t\t\t\tfileName: \"\"\n\t\t\t});\t\n\n\t\t\ttc_needstorun = \"yes\";\n\t\t\ttc_waitingOK = \"no\";\n\t\t\ttc_status=7;\n\t\t\tbreak;\n\t\t}\n\t\tcase 7:\t\t//At tool change location\n\t\t{\n\t\t\ttc_message = \"At tool change location<br><br>If tool is changed, use Set New Tool before returning to original location or a crash may occur!\";\n\t\t\ttc_status = 0;\n\t\t\tbreak;\n\t\t}\n\t\t\n\t\tcase 8:\t\t//Return to original position\n\t\t{\n\t\t\tif(tc_waitingOK == \"yes\") {break;}\n\t\t\tconsole.log(\"tc_zpos \" + tc_zpos + \" tc_newz \" + tc_newz);\n\t\t\tvar targetz = (tc_zpos*1 + tc_newz*1);\n\t\t\tconsole.log (\"target Z \" + targetz);\n\t\t\tif((targetz*1) > (0*1)) {\t\t\t\t\t\t//Check that there is enough headroom for the new tool to return to previous Z\n\t\t\t\ttc_status = 0;\t\t\t\t\t\t\t\t//Skip the move\n\t\t\t\ttc_message = \"Insufficient Z clearance to return safely to previous position<br>Please use the jog controls to set the required position\";\t\t\t\t\n\t\t\t\tconsole.log(\"Target Z greater than or equal to zero\");\n\t\t\t\tprintLog(\"Insufficient Z clearance to return to previous position\");\n\t\t\t\talert (\"Insufficient Z clearance to return safely to previous position\");\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\ttc_message = \"Returning to the original position\";\n\t\t\t\n\t\t\tvar tc_goback =  `\n\t\t\tG21 \t\t\t\t\t\t\t\t\t\t;set mm mode\n\t\t\tG90\t\t\t\t\t\t\t\t\t\t\t;absolute coordinates\n\t\t\tG53 G0 Z-5\t\t\t\t\t\t\t\t\t;Raise to safe height in machine coordinates\n\t\t\tG0 X` + tc_xpos + ` Y` + tc_ypos +`\t\t \t;Traverse to old X & Y position\n\t\t\tG1 Z` + tc_zpos + `\tF` +tc_finalzfeed +` \t;Lower to old Z position at slower feed\n\t\t\t`\n\t\t\tsocket.emit('runJob', {\n\t\t\t\tdata: tc_goback,\n\t\t\t\tisJob: \"no\",\n\t\t\t\tcompletedMsg: \"\",\n\t\t\t\tfileName: \"\"\n\t\t\t});\t\n\n\t\t\ttc_needstorun = \"yes\";\n\t\t\ttc_status = 9;\n\t\t\tbreak;\n\t\t}\n\t\tcase 9:\t\t// Done\n\t\t{\n\t\t\tif (tc_refset==\"no\"){tc_message = \"No reference stored - Please set Reference Tool\";}\n\t\t\telse {tc_message=\"Reference offset (\" + tc_offset + \")\";}\n\t\t\ttc_waitingOK = \"no\";\n\t\t\ttc_status=0;\n\t\t\tbreak;\n\t\t}\n\t\tcase 99:\t//Exiting - clean up and go.\n\t\t{\t\t\t\n\t\tif(tc_unitsmode != \"\") {sendGcode(tc_unitsmode);}\t// Restore modal settings if they were read\n\t\tif(tc_distmode != \"\") {sendGcode (tc_distmode);}\n\t\ttc_message =\"Closing\";\n\t\tclearInterval(window.tc_refinterval);\n\t\ttc_status=0;\n\t\tbreak;\n\t\t}\n\t\tdefault:\n\t\t{\n\t\t}\n      } \t  \n    }\n  }, 100)\n}\n}\n\nwindow.tc_debug=function(){\nconsole.log(\"Status\" + laststatus.comms.runStatus);\nconsole.log(\"waiting OK \" + tc_waitingOK);\nconsole.log(\"Stage \" + tc_status);\nconsole.log(\"X \" + tc_xpos);\nconsole.log(\"Y \" + tc_ypos);\nconsole.log(\"Z \" + tc_zpos);\nconsole.log(\"Units  \" + tc_unitsmode);\nconsole.log(\"Distance \" + tc_distmode);\nconsole.log(\"Offset \" + tc_offset);\nconsole.log(\"Reference Offset Stored? \" + tc_refset);\nconsole.log(\"Message \" + tc_message);\n}\n\nwindow.tc_crackon = function() {\t\t\t// Proceed button pressed - clear flag.\ntc_waitingOK = \"no\";\n}\n\nwindow.tc_updateui = function() {\t\t\t// Update UI elements\n\tif(tc_waitingOK == \"yes\") {$(\"#tc_ok\").removeClass(\"disabled\")}else{$(\"#tc_ok\").addClass(\"disabled\")}\n\tif(tc_refset == \"yes\") {$(\"#tc_changetool\").removeClass(\"disabled\")}else{$(\"#tc_changetool\").addClass(\"disabled\")}\n\t$(\"#tc_log\").html(tc_message)\n}\n\nwindow.tc_safetycheck = function() {\t\t// Check that machine is in a fit state to run the macro\n\n\tvar tc_returnval = 1;\t\t\t\t\t\t\t\t\t\t// Flag for machine state 1 = safe to proceed / 0 = not safe\n\t\n\tif(laststatus.comms.runStatus != \"Idle\") {\t\t\t\t\t// Check that machine is idle\n\t\talert (\"This macro can't be used whilst a program is running or in alarm (Machine must be Idle)\");\n\t\ttc_returnval = 0;\n\t}\n\t\n\tif(laststatus.machine.modals.spindlestate != \"M5\") {\t\t// Check that spindle is stopped\n\t\talert (\"Spindle must be stopped to use this macro (Spindle state M5 - currently \" + laststatus.machine.modals.spindlestate +\")\");\n\t\ttc_returnval = 0;\n\t}\n\t\n\treturn (tc_returnval);\n}\n\nwindow.tc_homecheck = function(){\t\t\t\t\t\t\t\t// Check whether machine thinks it has been homed & give the option to override\n\tvar tc_oktogo = -1;\t\t\t\t\t\t\t\t\t\t\t// Flag: -1 = not verified / 0 = not homed, don't continue / 1 = OK to continue\n\n\tif((laststatus.machine.modals.homedRecently == true)||(tc_ignorehomestatus == \"yes\")) {\t\t// Machine has been homed, or we don't care\n\t\ttc_oktogo = 1;\n\t\tif (tc_ignorehomestatus != \"yes\") {\n\t\t\tconsole.log(\"Machine reports it has been homed\");\n\t\t}\n\t\telse\n\t\t{\n\t\t\tconsole.log(\"Machine homed check disabled\");\n\t\t}\n\n\t}\n\telse\t\n\t{\n\t\tMetro.dialog.create({\t\t\t\t\t\t\t\t\t// Machine not homed, so create a dialog to decide what to do next\n\t\t\ttitle: \"Machine reports that it hasn't been homed!\",\n\t\t\tcontent: \"<div>This macro uses machine coordinates. It is strongly recommended that the machine is homed before continuing. Please click 'Go Back' and then home the machine.</div><p><div>Continuing without homing risks the machine crashing unless you know what you are doing.</div>\",\n\t\t\tactions: [\n\t\t\t{\n\t\t\t\tcaption: \"Go Back\",\n\t\t\t\tcls: \"js-dialog-close alert\",\n\t\t\t\tonclick: function(){\n\t\t\t\t\tprintLog(\"Machine not homed warning heeded\");\n\t\t\t\t\ttc_oktogo = 0;\n\t\t\t\t\t}\n\t\t\t},\n\t\t\t{\n\t\t\t\tcaption: \"Continue Anyway\",\n\t\t\t\tcls: \"js-dialog-close\",\n\t\t\t\tonclick: function(){\n\t\t\t\t\tprintLog(\"Machine not homed warning ignored\");\n\t\t\t\t\tconsole.log(\"Machine not homed warning ignored\");\n\t\t\t\t\ttc_oktogo = 1;\n\t\t\t\t\t}\n\t\t\t}\n\t\t\t]\n\t\t});\n\t}\n\t\t\t\t\t\n\twindow.tc_refinterval = setInterval(function() {\t\t// Set up loop to wait for dialog choices\n\t\tif(tc_oktogo !=-1){\t\n\t\t\tclearInterval(window.tc_refinterval);\n\t\t\tif (tc_oktogo == 1) tc_initiate();\t\t\t// Proceed to main program\n\t\t}\n\t\t\n\t}, 100)\n}","class":"secondary","tooltip":"","macrokeyboardshortcut":"","jsrunonstartup":false}